<!DOCTYPE>
<html>
<head>
<title>Sky Hopper - Web Application for Sky Navigation</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
<style>
body { font-size: 5mm ; color:red ; font-family: sans; background-color:black }
a:link {color: red;}
a:visited { color: red; }
a:active { color:red; }
a:hover { color:red; }
button { height:10mm; font-size:5mm ; text-align:center; vertical-align: middle; background-color:black; color:red; border: 2px solid red }
.comp_but, .incdec_but { width: 10mm ; height:10mm; font-size:5mm ; padding: 0 }
.comp_but { float:right }
.only_tiny { display : none }
.only_tiny_tr { display : none }
.only_full { display : inline }

.manual_background {
    background: url(manual-blk.png) no-repeat center center;
    background-size: 10mm 10mm;
}

.compass_background {
    background: url(compass-blk.png) no-repeat center center;
    background-size: 10mm 10mm;
}

.nocompass_background {
    background: url(nocompass-blk.png) no-repeat center center;
    background-size: 10mm 10mm;
}

.settings_background {
    background: url(settings-blk.png) no-repeat center center;
    background-size: 10mm 10mm;
}


input[type=text], input[type=text]:focus, textarea, input[type=submit]{
	border: 2px solid red;
	color:red;
	background:black;
}

input[type=text], input[type=text]:focus, input[type=submit] {
	height:10mm;
	font-size:5mm;
        padding: 0;
	vertical-align: middle; background-color:black; 
}
input[type=submit] { width:10mm;}
</style>
<body>
<canvas style="position:absolute; left:0; top:0; z-index:-1"  id="myCanvas" width="640" height="480"> </canvas>
<p>
	<span class="only_full"><button class="ui_but" onclick="align();">Align</button></span>
	<span class="only_tiny"><button class="incdec_but" onclick="align();">&#x25ce;</button></span>
	<span class="only_tiny" id="alignment_tiny"></span><span class="only_full" id="alignment"></span> <span id="countdown"></span>
	<button class="comp_but nocompass_background" id="nocompass_button" style="display:none">&nbsp;</button>
	<button class="comp_but manual_background" id="hand_button" style="display:none;" onclick="manualMode();">&nbsp;</button>
	<button class="comp_but compass_background" id="compass_button" style="display:none" onclick="compassMode();">&nbsp;</button>
</p>
<div class="only_full">
<p>
		<button class="incdec_but" onclick="incFOV();">-</button>
		<button class="incdec_but" onclick="decFOV();">+</button>
		&angle;<span class="fov_val">60&deg;</span>
		<span style="float:right">
			<button class="comp_but settings_background" onclick="showConfig('inline');">&nbsp;</button>
		</span>
</p>
</div>
<p class="only_tiny"><button class="comp_but settings_background" onclick="showConfig('inline');">&nbsp;</button>
</p>
<p style="display:none" id="wl_ctl"><button  class="incdec_but" onclick="watchListItemUpdate(-1);">&lt;</button> <button class="incdec_but" onclick="watchListItemUpdate(1);">&gt;</button><br/><i><span id="wl_target_name"></span></i></p>

<p id="gps">No Geolocation</p>
<div id="object_log" style="display:none">
<p>Sirius:<span id="Sirius_alt"></span>, <span id="Sirius_az"></span></p>
<p>Mars:<span id="Mars_alt"></span>, <span id="Mars_az"></span></p>
<p>Rigel:<span id="Rigel_alt"></span>, <span id="Rigel_az"></span></p>
<p>Jupiter:<span id="Jupiter_alt"></span>, <span id="Jupiter_az"></span></p>
</div>
<p id="orient"></p>
<p id="status"></p>
<div class="config_div" id="allow_orientation" style="display:none; position:absolute; left:10%; top:10%; z-index:3 ; padding: 1% 1% 1% 1%; width: 78%; background:black; border: 1px solid red ; text-align:center ">
<button class="ui_but" style="height:30mm" onclick="iOSOrientation();">Enable Device Orientation</button>
</div>
<div class="config_div" id="config" style="display:none; position:absolute; left:5%; top:5%; z-index:2 ; padding: 1% 1% 1% 1%; width: 88%; background:black; border: 1px solid red ">
<span style="position:absolute; right:1mm; top:1mm">
<button class="incdec_but" onclick="showManual(true)">?</button>
<button class="incdec_but" onclick="showConfig('none');">X</button>
</span>
<p><b>Settings (version)</b></p>
<p>
<button class="ui_but" onclick="resetAll();">&#x21bb;</button>
<input class="dso_selector" id="small_screen" type="checkbox" onchange="smallScreen(this.checked)"   /><label for="small_screen" >Small UI</label> 
<input class="dso_selector" id="NM_checked" type="checkbox" onchange="switchNightMode(this.checked)" /><label for="NM_checked" >Night</label>
<input class="dso_selector" id="FS_checked" type="checkbox" onchange="toggleFS(this.checked)"        /><label for="FS_checked" >Full S.</label>
</p>
<table>
<tr class="only_tiny_tr">
	<td>FOV</td>
	<td>
		<button class="incdec_but" onclick="incFOV();">-</button> <button class="incdec_but" onclick="decFOV();">+</button>
	</td>
	<td>
		&angle;<span class="fov_val">60&deg;</span>
	</td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td>Stars</td>
	<td>
		<button class="incdec_but" onclick="decMAG();">-</button> <button class="incdec_but" onclick="incMAG();">+</button>
	</td>
	<td>
		<i>m&leq;</i><span id="mag_val">4</span>
	</td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td>DSO</td>
	<td>
		<button class="incdec_but" onclick="dsoMagUpdate(-1);">-</button> <button class="incdec_but" onclick="dsoMagUpdate(1)">+</button>
	</td>
	<td>
		<i>m&leq;</i><span id="dso_level_val">5</span>
	</td>
	<td>&nbsp;</td>
</tr>
<tr>
	<td>List</td>
	<td>
		<button  class="incdec_but" onclick="prevWatchList();">&lt;</button> <button class="incdec_but" onclick="nextWatchList()">&gt;</button>
	</td>
	<td id="wl_sel">None</td>
	<td>
		<a id="list_edit_toggle" href="javascript:toggleEditWL()">[edit]</a>
	</td>
</tr>
</table>

<div id="wl_edit" style="display:none;">
	<p>name: dso1, dso2, dso3, &#x2026;</p>
	<p>
	    <textarea id="user_wl" style="width:80%" rows="5"></textarea>
	</p>
	<p><button class="ui_but" onclick="saveWL();" >Save</button> <button class="ui_but" onclick="discardWL();" >Discard</button></p>
	<p id="wl_errors"></p>
</div>
<form onsubmit="return hideSettingIfSelectionOk()" >
<p> <input id="search_field" type="text" oninput="findTargetByName(this.value)" onclick="this.value='';" onfocus="findTargetByName(this.value)" style="width:30%" /> <input type="submit" value="&#x2315;"/> <b><span style="float:right" id="find_status"><span></b></p>
</form>
<p><input class="dso_selector" id="P_checked"  type="checkbox" checked="checked" onchange="global_show_obj.P  = this.checked;" /><label for="P_checked" >Planets</label></p>
<p><input class="dso_selector" id="Oc_checked" type="checkbox" checked="checked" onchange="global_show_obj.Oc = this.checked;" /><label for="Oc_checked">Clusters and Clouds</label></p>
<p><input class="dso_selector" id="Gc_checked" type="checkbox" checked="checked" onchange="global_show_obj.Gc = this.checked;" /><label for="Gc_checked">Globular Clusters</label></p>
<p><input class="dso_selector" id="Ga_checked" type="checkbox" checked="checked" onchange="global_show_obj.Ga = this.checked;" /><label for="Ga_checked">Galaxies</label></p>
<p><input class="dso_selector" id="Ne_checked" type="checkbox" checked="checked" onchange="global_show_obj.Ne = this.checked;" /><label for="Ne_checked">Nebulae</label></p>
<p><input class="dso_selector" id="Ca_checked" type="checkbox" checked="checked" onchange="global_show_obj.Ca = this.checked;" /><label for="Ca_checked">Constellations</label></p>
<p><input class="dso_selector" id="U_checked" type="checkbox" checked="checked" onchange="global_show_obj.U = this.checked;" /><label for="U_checked">User Objects</label> <a id="edit_user_dso" href="javascript:toggleEditDSO();">[edit]</a></p>
<div id="dso_edit" style="display:none;">
<p>Name,RA(hh:mm:ss),DE(Â±dd:mm:ss)</p>
<p>
    <textarea id="user_dso" style="width:80%" rows="5"></textarea>
</p>
<p><button class="ui_but" onclick="saveUserDSO();" >Save</button> <button class="ui_but" onclick="discardUserDSO();" >Discard</button></p>
<p id="dso_errors"></p>
</div>
<hr>
<p><button class="incdec_but" onclick="requestGeolocation();">&#x21bb;</button> GPS: <span id="lat">Unknown</span>, <span id="lon">Unknown</span></p>
<p>&#x03B1;=<span id="ang_a"></span> &#x03B2;=<span id="ang_b"></span> &#x03B3;=<span id="ang_g"></span> C=<span id="ang_c"></span> UTC=<span id="utc_time"></span></p>
</div>

<div style="position:absolute; left:0; top:0; z-index:5; width:100%; background:black; display:none;" id="manual">
<span style="float:right; margin-right: 2mm; margin-top:2mm">
<button class="incdec_but" onclick="showManual(false);">X</button>
</span>
MANUAL
</div>

<script src="vsop87-multilang/Languages/JavaScript/vsop87a_xsmall.js"></script>
<script>
vsop87a_full = vsop87a_xsmall;
</script>
<script src="vsop87-multilang/Languages/JavaScript/astrolib.js"></script>
<script src="jsdb.js"></script>
<script>

var global_day_style = {
	cross 		: 'blue',
	constelations 	: 'yellow',
	bearing 	: 'green',
	star		: 'white',
	altaz		: 'red',
	target		: 'cyan',
	align		: 'magenta'
};

var global_show_obj = {
	'S': true,
	'Oc': true,
	'Gc': true,
	'Ca': true,
	'Ga':true,
	'Ne':true,
   	'P': true,
    'U': true
};

var global_night_style = {
	cross 		: 'red',
	constelations 	: '#880000',
	bearing 	: 'red',
	star		: 'red',
	altaz		: 'red',
	target		: 'red',
	align		: '#AA0000'
};



var global_style = global_day_style;

var global_targets_list = [];
var global_prev_xy=null;
var global_target_index = -1;
var global_align_index = -1;
var global_expecting_select = null;
var global_camera_projection = true;
var global_expected_frame_rate_ms = 66;
var global_use_compass = false;
var global_dso_mag = parseInt(document.getElementById('dso_level_val').innerHTML);

var global_fov_index = 3;
var global_fov_values = [7,15,30,60,90,120,150]
var global_fov = global_fov_values[global_fov_index];
var global_mag = 4;
var gdata = {
	"lat" : 31.9,
	"lon" : 34.8,
	"compass_alpha" : 0,
	"alpha" : 0,
	"alpha_user_offset" : 0,
	"alpha_gyro" : 0,
	"alpha_diff" : 0,
	"beta" : 0,
	"gamma" : 0,
	"time" : Date.now(), //1614716453109
}

var global_align_matrix = [1,0,0,0,1,0,0,0,1];
var global_use_gyro = false;
var global_full_screen = false;

var global_status = "";

var global_watchlist = null;

function showManual(v)
{
	document.getElementById('manual').style.display = v ? 'inline' : 'none';
}
function setDisplayByClass(cls,value)
{
	var el = document.getElementsByClassName(cls);
	for(var i=0;i<el.length;i++) {
		el[i].style.display = value;
	}
}

function smallScreen(v)
{
	var tiny = v ? 'inline' : 'none';
	var tiny_tr = v ? 'table-row' : 'none';
	var full = v ? 'none' : 'inline';
	setDisplayByClass('only_tiny_tr',tiny_tr);
	setDisplayByClass('only_tiny',tiny);
	setDisplayByClass('only_full',full);
}


function showStatus(v)
{
	global_status += v+"<br/>"
	document.getElementById('status').innerHTML = global_status;
}

function showConfig(v)
{
	document.getElementById('config').style.display = v;
}
function toggleFS(fs)
{
	if(fs) {
		document.documentElement.requestFullscreen({navigationUI:'hide'});
	}
	else {
		document.exitFullscreen();
	}
}


function hideSettingIfSelectionOk()
{
	var value = document.getElementById("search_field").value;
	if(findTargetByName(value)) {
		showConfig('none')
	}
	return false;
}

function findTargetByName(name ='')
{
	var found = document.getElementById('find_status')
	var name = name.toUpperCase();
	var N=allstars_index_name.names.length;
	var found_index = -1;
	if(name != '') {
		for(var i=0;i<N;i++) {
			let candidate = allstars_index_name.names[i];
			if(candidate == name) {
				found_index = i;
				break;
			}
			else if(found_index != -2 && candidate.startsWith(name)) {
				if(found_index == -1) {
					found_index = i;
				}
				else {
					found_index = -2;
				}
			}
		}
	}
	if(found_index >= 0) {
		global_target_index = allstars_index_name.index[found_index];
		found.innerHTML = allstars[global_target_index].name;
		return true;
	}
	else {
		global_target_index = -1;
		found.innerHTML = '';
		return false;
	}
}
function incMAG()
{
	if(global_mag < 6)
		global_mag += 1;
	updateMAG()
}
function decMAG()
{
	if(global_mag > 1)
		global_mag -=1;
	updateMAG();
}
function updateMAG()
{
	document.getElementById("mag_val").innerHTML = global_mag + "";
}

function incFOV()
{
	if(global_fov_index + 1 < global_fov_values.length)
		global_fov_index++;
	updateFOV()
}
function decFOV()
{
	if(global_fov_index > 0)
		global_fov_index--;
	updateFOV();
}
function updateFOV()
{
	global_fov = global_fov_values[global_fov_index];
	var vals = document.getElementsByClassName("fov_val");
	for(var i=0;i<vals.length;i++) {
		vals[i].innerHTML = global_fov + "&deg;";
	}
}

function setUseGyro(val,message=null,message_tiny=null)
{
	global_use_gyro = val;
	if(message) {
		var status = message;
	}
	else {
		var status= global_use_gyro ? "Aligned" : "Not Aligned";
	}
	if(message_tiny) {
		var status_t = message_tiny;
	}
	else {
		var status_t = global_use_gyro ? "â" : "â";
	}
	document.getElementById("alignment").innerHTML = status;
	document.getElementById("alignment_tiny").innerHTML = status_t;
}

function resetAll()
{
	global_expecting_select = selectTaret;
	findTargetByName();
	global_target_index = -1;
	document.getElementById('find_status').innerHTML = '';
	global_align_index = -1;
	setUseGyro(false);
}

function align()
{
	if(global_expecting_select == doNothing)
		return;
	/// realign in manual mode
	if(global_use_gyro && !global_use_compass) {
		// keep bearing
		gdata.alpha_user_offset = gdata.alpha_gyro + gdata.alpha_diff - gdata.alpha;
	}
	setUseGyro(false,"Select Star","?");
	global_align_index = -1;
	global_expecting_select = selectAlignWithTimer;
}

function normV(v)
{
	var len = Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);
	return [v[0]/len,v[1]/len,v[2]/len];
}

function matMul(A,B)
{
	var v1 = mvec(A,[B[0],B[3],B[6]]);
	var v2 = mvec(A,[B[1],B[4],B[7]]);
	var v3 = mvec(A,[B[2],B[5],B[8]]);
	return [v1[0],v2[0],v3[0],
		v1[1],v2[1],v3[1],
		v1[2],v2[2],v3[2]];
}

function matAdd(A,alpha,B,beta)
{
	var res = [];
	for(var i=0;i<9;i++) {
		res.push(A[i]*alpha + B[i]*beta);
	}
	return res;
}

function matEye()
{
	return [1,0,0, 0,1,0, 0,0,1];
}

function doNothing(index)
{
}

function selectAlignWithTimer(index,start_val=3)
{
	var cd = document.getElementById("countdown");
	global_align_index = index;
	global_expecting_select = doNothing;
	if(start_val <= 0) {
		cd.innerHTML="";
		selectAlign(index);
	}
	else {
		cd.innerHTML = start_val.toFixed(1) + "s";
		setTimeout(function() {
			selectAlignWithTimer(index,start_val - 0.1);
		},100);
	}
}

function selectAlign(index)
{
	var camRays =  getCameraRays();
	var st = allstars[index];
	var tr = rayFromPos(st.RA,st.DE);
	var fw = camRays[2];
	var left = camRays[1];
	var dAZ = Math.asin(crossProd(normV([tr[0],tr[1],0]),normV([fw[0],fw[1],0]))[2]);
	var dAlt = Math.asin(tr[2]) - Math.asin(fw[2]);
	// rotate around AZ axis
	var daz_mat =  [  Math.cos(dAZ), Math.sin(dAZ), 0,
			 -Math.sin(dAZ), Math.cos(dAZ), 0,
			 0,		 0,		1];
	// rotate around up/dwn - axis of the camera
	var u0 = left[0];
	var u1 = left[1];
	var u2 = left[2];
	var W = [ 0, -u2, u1,   u2, 0, -u0,  -u1, u0, 0 ]
	var dalt_mat = matAdd(matEye(),1,W,Math.sin(-dAlt));
	dalt_mat = matAdd(dalt_mat,1,matMul(W,W),2*Math.sin(-dAlt/2)*Math.sin(-dAlt/2));
	
	//global_align_matrix = daz_mat;
	global_align_matrix = matMul(daz_mat,dalt_mat); 
	
	setUseGyro(true);
	gdata.alpha_diff = (gdata.alpha + gdata.alpha_user_offset) - gdata.alpha_gyro;
	global_align_index = index;
	global_expecting_select = selectTaret;
}

/// rotation matrix is 
/// taken from https://www.w3.org/TR/2016/CR-orientation-event-20160818/#worked-example-2

var degtorad = Math.PI / 180; // Degree-to-Radian conversion


function getRotationMatrix( alpha, beta, gamma ) {

  var _x = beta  ? beta  * degtorad : 0; // beta value
  var _y = gamma ? gamma * degtorad : 0; // gamma value
  var _z = alpha ? alpha * degtorad : 0; // alpha value

  var cX = Math.cos( _x );
  var cY = Math.cos( _y );
  var cZ = Math.cos( _z );
  var sX = Math.sin( _x );
  var sY = Math.sin( _y );
  var sZ = Math.sin( _z );

  //
  // ZXY rotation matrix construction.
  //

  var m11 = cZ * cY - sZ * sX * sY;
  var m12 = - cX * sZ;
  var m13 = cY * sZ * sX + cZ * sY;

  var m21 = cY * sZ + cZ * sX * sY;
  var m22 = cZ * cX;
  var m23 = sZ * sY - cZ * cY * sX;

  var m31 = - cX * sY;
  var m32 = sX;
  var m33 = cX * cY;

  return [
    m11,    m12,    m13,
    m21,    m22,    m23,
    m31,    m32,    m33
  ];

};

function mvec(m,v)
{
	return [ m[0] * v[0] + m[1] * v[1] + m[2] * v[2],
		 m[3] * v[0] + m[4] * v[1] + m[5] * v[2],
		 m[6] * v[0] + m[7] * v[1] + m[8] * v[2] ];
}

function crossProd(a,b)
{
	return [ a[1]*b[2] - a[2]*b[1],
		 a[2]*b[0] - a[0]*b[2],
		 a[0]*b[1] - a[1]*b[0] ];
}

function getCameraRays()
{
	// zxy
	// after Mul comonents are [S,E,D]
	var alpha = global_use_gyro ? gdata.alpha_gyro + gdata.alpha_diff : gdata.alpha + gdata.alpha_user_offset;
	var M = getRotationMatrix(alpha,gdata.beta,gdata.gamma);
	//var top = mvec(M,[1,0,0]);
	//var lft = mvec(M,[0,1,0]);
	//var fwd = mvec(M,[0,0,-1]);
	
	

	var fwd = mvec(M,[0,1,0]);

	// make sure left  is horizontal

	var fwd_hlen = Math.sqrt(fwd[0]*fwd[0] + fwd[1]*fwd[1])
	var fwd_hor = [fwd[0]/fwd_hlen,fwd[1]/fwd_hlen,0.0];

	var lft = [-fwd_hor[1],fwd_hor[0],0.0]
	var top = crossProd(fwd,lft);

	if(global_use_gyro) {
		return [
			mvec(global_align_matrix,top),
			mvec(global_align_matrix,lft),
			mvec(global_align_matrix,fwd)
		];
	}
	else {
		return [top,lft,fwd];
	}
}

function rayFromPos(RAd,DEd)
{
	var deg2rad = Math.PI / 180;
	RA = RAd * deg2rad;
	DE = DEd * deg2rad;
	var jd = gdata.time * 1e-3 / 86400.0 + 2440587.5;
	var tu = jd - 2451545.0;
	var angle = Math.PI * 2 * (0.7790572732640+1.00273781191135448 * tu);
	var q = angle + gdata.lon*deg2rad;
	var H = q - RA;
	
	var f = deg2rad * gdata.lat;

	var az_y = Math.sin(H);
	var az_x = (Math.cos(H) * Math.sin(f) - Math.tan(DE) * Math.cos(f));
	var az = Math.atan2(az_y,az_x)
	var sinH = Math.sin(f) * Math.sin(DE) + Math.cos(f) * Math.cos(DE) * Math.cos(H);
	var hz = Math.asin(sinH)
	var ray_n = -Math.cos(az) * Math.cos(hz);
	var ray_e = -Math.sin(az) * Math.cos(hz);
	var ray_u = Math.sin(hz);
	return [ ray_e, ray_n, ray_u ];
}

function sprod(v1,v2)
{
	return v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2];
}

function cameraBearing(RAd,DEd,cameraRays)
{
	var ray = rayFromPos(RAd,DEd);
	var top = cameraRays[0];
	var lft = cameraRays[1];
	var fwd = cameraRays[2];
	var x = -sprod(lft,ray);
	var y = sprod(top,ray);
	var z = sprod(fwd,ray);
	return {"x":x,"y":y,"z":z};
}

function getFOV()
{
	var ratio = canvas.width / canvas.height;
	var fov_td,fov_lr;
	if(ratio < 1) {
		fov_td = global_fov;
		fov_lr = fov_td * ratio;
	}
	else {
		fov_lr = global_fov;
		fov_td = fov_lr / ratio;
	}
	return {"lr":fov_lr,"td":fov_td};
}


function xyzTo2d(xyz,in_fov=true)
{
	var deg2rad = Math.PI / 180;
	var fov = getFOV();
	var fov_td = fov.td * deg2rad / 2;
	var fov_lr = fov.lr * deg2rad / 2;
	var x=xyz.x; var y=xyz.y;  var z=xyz.z;

	if(z<=0)
		return null;
	if(global_camera_projection) {
		var lim_x = Math.sin(fov_lr);
		var lim_y = Math.sin(fov_td);
	}
	else {
		x = Math.asin(x);
		y = Math.asin(y)
		var lim_x = fov_lr;
		var lim_y = fov_td;

	}
	if(in_fov) {
		if(x < -lim_x || x > lim_x)
			return null;
		if(y < -lim_y || y > lim_y)
			return null;
	}
	return { x:(x + lim_x) / (lim_x*2), y: 1 - (y + lim_y) / (lim_y * 2) };
}
function projectToCamera(RAd,DEd,cameraRays,in_fov=true)
{
	var xyz = cameraBearing(RAd,DEd,cameraRays)
	return xyzTo2d(xyz,in_fov);
}

function formatSize(arcmin)
{
	var res = '';
	const lim_factor = 3;
	if(arcmin >= 60) {
		var deg = Math.floor(arcmin / 60);
		res += deg + "Â°";
		var m = Math.floor(arcmin - deg * 60);
		if(arcmin < 60 * lim_factor && m != 0) {
			res += m + "â²";
		}
	}
	else if(arcmin >= 1) {
		var m = Math.floor(arcmin);
		res += m + "â²";
		var s = Math.floor((arcmin - m)*60)
		if(arcmin < 1 * lim_factor && s != 0) {
			res += s + "â³";
		}
	}
	else {
		res = Math.floor(arcmin * 60) + "â³";
	}
	return res;
}

function plotStar(star,camRays,highlight)
{
	var pos = projectToCamera(star.RA,star.DE,camRays);
	if(!pos)
		return null;
	context.beginPath();	
	var size = star.t == 'S' ? 6.5 - star.AM : 6 ;
	if(size < 1)
		size = 1;
	var color;
	if(highlight >= 2) {
		color = highlight == 3 ? global_style.target : global_style.align;
		size = 10;
	}
	else {
		color = global_style.star;
	}
	if(star.t == 'S')
		context.fillStyle = color;
	else
		context.fillStyle = 'black';
	var pix_x = pos.x * canvas.width;
	var pix_y = pos.y * canvas.height;
	result = { x: pix_x, y:pix_y , index:-1};
	if(highlight == 0)
		return result;
	if(star.t != 'Ca') {
		context.strokeStyle = color;
		context.lineWidth = 1;
		if(star.t == 'Ga') {
			context.ellipse(pix_x,pix_y,size*1.5,size/1.5,Math.PI/4,0,2*Math.PI,false);
			context.fill();
			context.stroke();
			context.beginPath();	
			context.arc(pix_x,pix_y,size/3,0,2*Math.PI,false);
			context.fillStyle = color;
			context.fill();
			context.stroke();
		}
		else if(star.t == 'Gc') {
			context.lineWidth = 2;
			context.setLineDash([1,3])
			context.arc(pix_x,pix_y,size,2*Math.PI,false);
			context.stroke();
			context.beginPath();	
			context.setLineDash([])
			context.fillStyle = color;
			context.arc(pix_x,pix_y,size/3,0,2*Math.PI,false);
			context.fill();
			context.stroke();
		}
		else if(star.t == 'Oc') {
			context.lineWidth = 2;
			context.setLineDash([1,3])
			context.arc(pix_x,pix_y,size,2*Math.PI,false);
			context.stroke();
			context.beginPath();	
			context.setLineDash([1,3])
			context.arc(pix_x,pix_y,size/3,0,2*Math.PI,false);
			context.fill();
			context.stroke();
			context.setLineDash([])
		}
		else if(star.t == 'Ne') {
			context.lineWidth = 1;
			context.moveTo(pix_x - size,pix_y - size);
			var f = 4;
			context.bezierCurveTo(pix_x + f*size,pix_y - size,pix_x -f*size,pix_y + size,pix_x+size,pix_y + size)
			context.stroke();
			context.beginPath();
			context.fillStyle=color;
			context.arc(pix_x,pix_y,size/3,0,2*Math.PI,false);
			context.fill();
			context.stroke();
		}
		else if(star.t == 'U') {
			context.lineWidth = 2;
			context.beginPath();	
			context.moveTo(pix_x-size,pix_y);
			context.lineTo(pix_x,pix_y+size);
			context.lineTo(pix_x+size,pix_y);
			context.lineTo(pix_x,pix_y-size);
			context.lineTo(pix_x-size,pix_y);
			context.fillStyle = 'black';
			context.fill();
			context.stroke();
		}
		else {
			context.arc(pix_x,pix_y,size,0,2*Math.PI,false);
			context.fill();
			context.stroke();
		}
	}
	if(star.name || highlight >= 2) {
		if(star.t == 'Ca') {
			color = global_style.constelations;
		}
		context.strokeStyle = color;
		context.fillStyle = color;
		if(star.t == 'Ca') {
			context.font = "4mm Sans"
			context.textBaseline = 'middle';
			context.textAlign = 'center';
			context.fillText(star.name,pix_x,pix_y)
		}
		else {
			let text = star.name ? star.name : '';
			let text_extra = []
			if(highlight > 1) {
				context.font = "6mm Sans";
				if(highlight == 3) {
					if(star.AM != -1)
						text_extra.push("m=" + star.AM.toFixed(1));
					if(star.s) {
						text_extra.push(formatSize(star.s));
					}
				}
			}
			else {
				context.font = "3mm Sans";
			}
			context.textBaseline = 'bottom';
			context.textAlign = 'start';
			context.fillText(text,pix_x + size + 1,pix_y - size - 1)
			if(text_extra) {
				context.textBaseline = 'top';
				context.fillText(text_extra.join(', '),pix_x + size + 1,pix_y - size/2 - 1)
				context.textBaseline = 'bottom';
			}
		}
	}
	return result;
}

function plotLines(camRays)
{
	if(!global_show_obj.Ca)
		return;
	for(var i=0;i<constellation_lines.length;i++) {
		line = constellation_lines[i];
		var p1 = projectToCamera(line.r0,line.d0,camRays,false);
		var p2 = projectToCamera(line.r1,line.d1,camRays,false);
		if(!p1 || !p2)
			continue;
		context.beginPath();	
		context.strokeStyle = global_style.constelations;
		context.lineWidth = 1;
		context.moveTo(p1.x*canvas.width,p1.y*canvas.height);
		context.lineTo(p2.x*canvas.width,p2.y*canvas.height);
		context.stroke();
	}
}


function plotCross()
{
	context.strokeStyle = global_style.cross;
	context.fillStyle = global_style.cross;
	context.lineWidth = 3;
	var dirs = [[1,0],[0,1],[-1,0],[0,-1]];
	var length = 50;
	var offset =10;
	for(var i=0;i<dirs.length;i++) {
		context.moveTo(canvas.width/2 + offset*dirs[i][0],canvas.height/2 + offset*dirs[i][1]);
		context.lineTo(canvas.width/2 + length*dirs[i][0],canvas.height/2 + length*dirs[i][1]);
	}
	context.stroke();
}

function plotBearing(xyz)
{
	context.beginPath();
	context.strokeStyle = global_style.bearing;
	context.fillStyle = global_style.bearing;
	context.lineWidth = 5;
	context.arc(canvas.width/2,canvas.height/2,10,0,2*Math.PI,false);
	context.moveTo(canvas.width/2,canvas.height/2);
	var dx = xyz.x;
	var dy = -xyz.y;
	var r = 1 / Math.sqrt(dx*dx+dy*dy);
	dx = dx*r;
	dy = dy*r;
	var length = 100;
	var pos = xyzTo2d(xyz);
	if(pos) {
		var px = canvas.width * (pos.x - 0.5); 
		var py = canvas.height * (pos.y - 0.5);
		var dist = Math.sqrt(px*px + py*py);
		if(dist < length)
			length = dist;
	}
	context.lineTo(canvas.width/2 + dx * length,canvas.height/2 + dy * length);
	var updn = (dy > 0 ? 'Down' : 'Up' ) + ' ' + Math.abs(Math.atan2(-xyz.y,xyz.z) / Math.PI * 180).toFixed(1) + '\u00b0';
	var left = (dx > 0 ? 'Right' : 'Left' ) + ' ' + Math.abs(Math.atan2(xyz.x,xyz.z) / Math.PI * 180).toFixed(1) + '\u00b0';
	context.stroke();
	context.lineWidth = 0;
	context.font = "6mm Serif";
	context.strokeStyle = global_style.bearing;
	context.fillStyle = global_style.bearing;
	context.textBaseline = 'middle';
	context.textAlign = 'end';
	context.fillText(updn,canvas.width - 5,canvas.height / 2)
	context.textAlign = 'center';
	context.textBaseline = 'bottom';
	context.fillText(left,canvas.width/2,canvas.height - 5)
}			


function logObject(thestar)
{
	if(thestar.name == 'Sirius' || thestar.name == 'Mars' || thestar.name == 'Jupiter' || thestar.name == 'Rigel') {
		document.getElementById('object_log').style.display='inline';
		if(1) {
			let ray = rayFromPos(thestar.RA,thestar.DE);
			let alt = Math.asin(ray[2]) / Math.PI * 180
				let az  = Math.atan2(ray[0],ray[1]) / Math.PI * 180;
			if(az < 0)
				az += 360;
			formatLatLon(thestar.name+"_alt",alt,'+','-');
			formatLatLon(thestar.name+"_az",az,'+','-');
		}
		else{
			let alt = thestar.RA / 15;
			let az  = thestar.DE;
			formatLatLon(thestar.name+"_alt",alt,'','-');
			formatLatLon(thestar.name+"_az",az,'+','-');
		}
	}
}

function getSolarSystemObject(p)
{
	var body = astrolib.bodies.indexOf(p);
	var r2d = 180 / Math.PI;
	var d2r = Math.PI / 180;
	var rLat = gdata.lat * d2r;
	var rLon = gdata.lon * d2r;
	var jd = astrolib.convertDateToJulianDate(new Date());
	var RaDec = astrolib.getBodyRaDec(jd,body,rLat,rLon,false);
	var RA = RaDec[2];
	var DEC = RaDec[1];
	return { "RA" : RA * r2d, "DE": DEC *r2d, "name": p, "AM" : -1 };
}


function updateDebugTime(v)
{
    var mins=Math.floor(v / 60000);
    var h = Math.floor(mins / 60) % 24
    var m = mins % 60;
    document.getElementById('utc_time').innerHTML = ('' + h).padStart(2,'0') + ':' + (m+'').padStart(2,'0')

}

function plotStars()
{
	var start=Date.now();
	
	if(canvas.width != document.body.clientWidth || canvas.height != document.body.clientHeight) {
		canvas.width = document.body.clientWidth;
		canvas.height = document.body.clientHeight;
	}
	
	global_targets_list=[];
	gdata.time = Date.now();
    updateDebugTime(gdata.time);
	var camRays = getCameraRays();
	context.fillStyle = "black";
	context.fillRect(0, 0, canvas.width, canvas.height);
	context.fillStyle = global_style.star;

	for(var i=0;i<allstars.length;i++) {
		var st = allstars[i].t;
		
		if(st == 'P') {
		    let pos = getSolarSystemObject(allstars[i].name);
		    allstars[i].RA = pos.RA;
		    allstars[i].DE = pos.DE;
		}
		
		//logObject(allstars[i]);
		
		var mag = allstars[i].AM;
		if((st == 'S' && mag > global_mag) || (st != 'S' && mag > global_dso_mag) || !global_show_obj[st])
		{
			i=allstars_index[st] - 1;
			continue
		}
		var highlight = 1;
		if(i == global_target_index || i == global_align_index)
			highlight = 0;
		var  pos = plotStar(allstars[i],camRays,highlight);
		// select only stars if not aligned
		// if aligned select all but constellations
		var waiting_for_align = global_expecting_select == selectAlignWithTimer;
		if(pos && st!='Ca' && (st == 'S' || !waiting_for_align)) {
			pos.index = i;
			global_targets_list.push(pos);
		}
	}
	if(global_align_index >= 0 && global_align_index != global_target_index) {
		plotStar(allstars[global_align_index],camRays,2);
	}
	if(global_target_index >= 0) {
		var star = allstars[global_target_index];
		var xyz = cameraBearing(star.RA,star.DE,camRays);
		plotBearing(xyz);
		plotStar(star,camRays,3);
	}
	else if(global_use_gyro) {
		plotCross();
	}
	plotLines(camRays);
	plotAltAz(camRays[2]);
	var passed = Date.now() - start;
	if(passed > global_expected_frame_rate_ms / 2) {
		setTimeout(plotStars,global_expected_frame_rate_ms);
	}
	else {
		setTimeout(plotStars,global_expected_frame_rate_ms-passed);
	}
}


function plotAltAz(fwd)
{
	var alt = Math.asin(fwd[2]) / Math.PI * 180;
	var az  = Math.atan2(fwd[0],fwd[1]) / Math.PI * 180;
	alt = 'Alt:' + alt.toFixed(1);
	if(az < 0)
		az = 360 + az;
	az  = 'Az:' + az.toFixed(1);
	context.font = "5mm Sans"
	context.textBaseline = 'bottom';
	context.textAlign = 'end';
	context.fillStyle = global_style.altaz;
	context.fillText(alt,canvas.width - 5,canvas.height - 5)
	context.textAlign = 'start';
	context.fillText(az,5,canvas.height - 5)
}

function selectTaret(index)
{
	findTargetByName();
	global_target_index = index;
	//global_expecting_select = null;
}

function selectionEvent(e)
{
	let x = e.clientX;
	let y = e.clientY;
	let min_dist = 1e100;
	let min_index = -1;
	for(var i=0;i<global_targets_list.length;i++) {
		let dx = global_targets_list[i].x - x;
		let dy = global_targets_list[i].y - y;
		let dist = dx*dx + dy*dy;
		if(min_dist > dist) {
			min_dist = dist;
			min_index = global_targets_list[i].index;
		}
	}
	if(global_expecting_select) {
		global_expecting_select(min_index);
	}
}

function formatLatLon(id,deg,pos,neg)
{
	var direction = deg >= 0 ? pos : neg;
	deg = Math.abs(deg);
	var ideg = Math.floor(deg);
	var min = 60*(deg - ideg);
	var imin = Math.floor(min);
	var sec = 60*(min - imin);
	var msg = direction + ideg + "\u00b0" + imin + "'" + sec.toFixed(1) + "''";
	document.getElementById(id).innerHTML = msg;
}

function showpos(position)
{
	var latlon = position.coords.latitude + "," + position.coords.longitude;
	gdata.lat = position.coords.latitude;
	gdata.lon = position.coords.longitude;
	formatLatLon("lat",gdata.lat,'N','S');
	formatLatLon("lon",gdata.lon,'E','W');
	document.getElementById("gps").style.display='none';
}

function requestGeolocation()
{
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showpos);
  }
}

function getLocation() {
  requestGeolocation();
  setTimeout(getLocation,600*1000)
}

function gyroListener(event)
{
	if(!(event.alpha === null)) {
		gdata.alpha_gyro = event.alpha;
		gdata.beta = event.beta;
		gdata.gamma = event.gamma;
		document.getElementById("orient").innerHTML = '';
	}
	else {
		document.getElementById("orient").innerHTML = 'No Gyro';
	}
	formatValue("ang_a",event.alpha);
	formatValue("ang_b",event.beta);
	formatValue("ang_g",event.gamma);
}

function deviceOrientationListenerIOS(event) {
	if(!(event.webkitCompassHeading === null)) {
		if(global_use_compass)
			gdata.alpha = event.webkitCompassHeading;
		gdata.compass_alpha = event.webkitCompassHeading;
	}
	else {
		noCompass();
	}
	formatValue("ang_c",event.webkitCompassHeading);
}

function deviceOrientationListener(event) {
	if(!(event.alpha === null)) {
		if(global_use_compass)
			gdata.alpha = event.alpha;
		gdata.compass_alpha = event.alpha;
	}
	else {
		noCompass();
	}
	formatValue("ang_c",event.alpha);
}


function noCompass()
{
	global_use_compass = false;
	document.getElementById("nocompass_button").style.display="inline";
	document.getElementById("compass_button").style.display="none";
	document.getElementById("hand_button").style.display="none";
}

function manualMode()
{
	global_use_compass = false;
	gdata.alpha_user_offset = gdata.alpha;
	gdata.alpha = 0;
	document.getElementById("compass_button").style.display="inline";
	document.getElementById("hand_button").style.display="none";
}

function compassMode()
{
	global_use_compass = true;
	gdata.alpha_user_offset = 0;
	gdata.alpha = gdata.compass_alpha;
	document.getElementById("compass_button").style.display="none";
	document.getElementById("hand_button").style.display="inline";
}

function manualDown(e)
{
	global_prev_xy = {"x":e.touches[0].clientX,"y":e.touches[0].clientY };
}

function manualMove(e)
{
	if(!global_prev_xy)
		return;
	
	var xy = {"x":e.touches[0].clientX,"y":e.touches[0].clientY };
	moveSky(global_prev_xy,xy);
	global_prev_xy = xy;
}
function manualUp(e)
{
	if(!global_prev_xy)
		return;
	var xy = {"x":e.touches[0].clientX,"y":e.touches[0].clientY };
	moveSky(global_prev_xy,xy);
	global_prev_xy = null;
}
function moveSky(prev,cur)
{
	if(global_use_compass)
		return;
	if(!prev || !cur)
		return;
	var fov =  getFOV().lr;
	var da = (cur.x - prev.x) / canvas.width * fov;;
	gdata.alpha_user_offset += da;
}

function dontPropMouseDown(lst)
{
	for(var i=0;i<lst.length;i++) {
		var elements = document.getElementsByClassName(lst[i]);
		for(var j=0;j<elements.length;j++) {
			elements[j].addEventListener('mousedown',function(e) {
				e.stopPropagation();
			});
		}
	}
}



function setupiOSOrientationEvents()
{
	if (window.DeviceOrientationEvent) {
		if(('ondeviceorientation' in window)) {
			window.addEventListener("deviceorientation", deviceOrientationListenerIOS);
			window.addEventListener("deviceorientation",gyroListener);
			compassMode();
		}
		else {
			unsupported();
		}
	} else {
		unsupported();
	}
	setUseGyro(false);
}


function setupOrientationEvents()
{
	if (window.DeviceOrientationEvent) {
		if(('ondeviceorientationabsolute' in window)) {
			window.addEventListener("deviceorientationabsolute", deviceOrientationListener);
			window.addEventListener("deviceorientation",gyroListener);
			compassMode();
		}
		else if(('ondeviceorientation' in window)) {
			window.addEventListener("deviceorientation",gyroListener);
			noCompass();
		}
		else {
			unsupported();
		}
	} else {
		unsupported();
	}
	setUseGyro(false);
}

function formatValue(uid,v)
{
	var msg='';
	if(v === undefined || v==null) {
		msg = 'No';
	}
	else {
		msg = v.toFixed(1);
	}
	document.getElementById(uid).innerHTML=msg;
}

function parseCSV(v)
{
    var res = new Array();
    var rows = v.split('\n');
    for(var r=0;r<rows.length;r++) {
        var parsed_row=new Array();
        if(rows[r].trim() == '')
            continue;
        var cols = rows[r].split(',');
        for(var c=0;c<cols.length;c++) {
            parsed_row.push(cols[c].trim())
        }
        res.push(parsed_row)
    }
    return res;
}

function parseRA(svalue)
{
    const re_float = /^(\d+\.\d+)$/;
    const re_colon = /^(\d+):(\d+)(?::(\d+(.\d+)?))?$/;
    const re_hms = /^(\d+)[hH \t]\s*(\d+)[mM'â²]\s*(?:(\d+(.\d+)?)(?:s|S|â²â²|â³|''))?$/;
    const re_space = /^(\d+)\s+(\d+)(?:\s+(\d+(.\d+)?))?$/;
    var res = svalue.match(re_float);
    var deg = null;
    if(res) {
        deg = parseFloat(res[1]);
        if(deg < 0 || deg > 360)
            return null;
        return deg;
    }
    res = svalue.match(re_colon) || svalue.match(re_hms) || svalue.match(re_space);
    if(!res)
        return null;
    var h = parseInt(res[1]);
    var m = parseInt(res[2]);
    var s = 0;
    if(res[3]) {
        s = parseFloat(res[3]);
    }
    if(h  >= 24 || m >= 60 || s >= 60) {
        return null
    }
    deg = 15 * (h + (60 * m + s) / 3600.0 );
    return deg;
}

function parseDEC(svalue)
{
    const re_float = /^([+-â]?\d+.\d+?)$/;
    const re_colon = /^([-+â]?)(\d+):(\d+)(?::(\d+(.\d+)?))?$/;
    const re_dms = /^([-+â]?)(\d+)[dDÂ° \t]\s*(\d+)[mM'â²]\s*(?:(\d+(.\d+)?)(?:s|S|â³|â²â²|''))?$/;
    const re_space = /^([-+â]?)(\d+)\s+(\d+)(?:\s+(\d+(.\d+)?))?$/;
    var res = svalue.match(re_float)
    if(res) {
        var deg = parseFloat(res[1])
        if(deg < -90 || deg > 90)
            return null;
        return deg;
    }
    res = svalue.match(re_colon) || svalue.match(re_dms) || svalue.match(re_space);
    if(!res)
        return null;
    var sig = (res[1] == '-' || res[1] == 'â')? -1.0 : 1.0;
    var d = parseInt(res[2]);
    var m = parseInt(res[3]);
    var s = 0;
    if(res[4]) {
        s = parseFloat(res[3]);
    }
    if(d  > 90 || m >= 60 || s >= 60)
        return null;
    return sig*(d + (60 * m + s) / 3600.0);
}


function toggleUI(link_id,ui_id)
{
	var ui = document.getElementById(ui_id);
	if(ui.style.display == "none") {
		ui.style.display="inline";
		document.getElementById(link_id).innerHTML = "[hide]";
	}
	else {
		ui.style.display="none";
		document.getElementById(link_id).innerHTML = "[edit]";
	}
}


function htmlEscape(v)
{
    return v.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,'&amp;').replace(/"/g,"&quot;").replace(/'/g,'&#x39;')
}

function discardUserDSO()
{
    loadUserDSO();
    toggleEditDSO();
}

function toggleEditDSO()
{
	toggleUI('edit_user_dso','dso_edit');
}

function saveUserDSO()
{
    resetUserDSOsAndMergeNewToAllStars();
    var text = document.getElementById('user_dso').value;
    var res = parseUserDSO(text);
    var dso_errors = document.getElementById('dso_errors');
    if(res[1].length > 0) {
        var msg = '<b>Errors:</b><ol>';
        for(var i=0;i<res[1].length;i++) {
            msg = msg + '<li>' + htmlEscape(res[1][i]) + '</li>';
        }
        msg = msg + '</ol>';
        dso_errors.innerHTML = msg;
    }
    else {
        dso_errors.innerHTML = '';
        window.localStorage.setItem('user_dso',text)
        resetUserDSOsAndMergeNewToAllStars(res[0]);
	toggleEditDSO();
    }
}

function parseUserDSO(value)
{
    var errors = []
    var dsos = new Array();
    var names = new Set(allstars_index_name.names);
    var new_names = new Set();
    var csv = parseCSV(value)
    for(var i=0;i<csv.length;i++) {
        if(csv[i].length<3) {
            errors.push('Too few colums in line ' + (i+1));
            continue;
        }
        var name = csv[i][0];
        if(name == "") {
            errors.push('Empty object name in line ' + (i+1));
            continue;
        }
        var sname = name.toUpperCase();
        if(names.has(sname)) {
            errors.push('Object ' + name + ' exists in data base')
            continue;
        }
        if(new_names.has(sname)) {
            errors.push('Duplicate object ' + name);
            continue;
        }
        var ra = parseRA(csv[i][1]);
        if(ra === null) {
            errors.push('Invalid RA value ' + csv[i][1])
            continue;
        }
        var de = parseDEC(csv[i][2]);
        if(de === null) {
            errors.push('Invalid DEC value ' + csv[i][2])
            continue;
        }
        new_names.add(sname)
        dsos.push({"name":name,"RA":ra,"DE":de,"AM":-1,"t":"U"});
    }
    return [dsos,errors]
}
function shortenArray(a,l)
{
    while(a.length > l) {
        a.pop();
    }
}

function resetUserDSOsAndMergeNewToAllStars(dsos = [])
{
    shortenArray(allstars,allstars_db_specs.items)
    shortenArray(allstars_index_name.names,allstars_db_specs.index_name_size)
    shortenArray(allstars_index_name.index,allstars_db_specs.index_name_size)
    for(var i=0;i<dsos.length;i++) {
        var pos = allstars.length;
        allstars.push(dsos[i])
        allstars_index_name.names.push(dsos[i].name.toUpperCase());
        allstars_index_name.index.push(pos);
    }
    allstars_index["U"] = allstars.length;
    if(global_target_index >= allstars.length) {
        selectTaret(-1);
    }
}

function setWatchList(wl)
{
	selectWatchList(-1);
	global_watchlist = wl;
}

function nextWatchList()
{
	if(global_watchlist.current_list + 1 >= global_watchlist.lists.length) {
		selectWatchList(-1);
	}
	else {
		selectWatchList(global_watchlist.current_list + 1);
	}

}

function prevWatchList()
{
	if(global_watchlist.current_list <= -1) {
		selectWatchList(global_watchlist.lists.length - 1);
	}
	else {
		selectWatchList(global_watchlist.current_list - 1);
	}

}

function watchListItemUpdate(offset)
{
	if(global_watchlist.current_list < 0 || global_watchlist.current_list >= global_watchlist.lists.length)
		return;
	var list = global_watchlist.lists[global_watchlist.current_list];
	if(global_target_index != -1) {
		var target = allstars[global_target_index];
		if(!target.name || target.name.toUpperCase() != list[global_watchlist.current_item].toUpperCase()) {
			offset = 0;
		}
	}
	global_watchlist.current_item = (global_watchlist.current_item + offset + list.length) % list.length;
	findTargetByName(list[global_watchlist.current_item]);
	markTarget();
}

function markTarget()
{
	var msgEl = document.getElementById("wl_target_name");
	if(global_watchlist.current_list == -1) {
		msgEl.innerHTML = "";
	}
	else {
		var name = global_watchlist.lists[global_watchlist.current_list][global_watchlist.current_item];
		msgEl.innerHTML = global_target_index == -1 ? ("?" + name + "?") : name;
	}
}	


function watchListNext()
{
	if(global_watchlist.current_list < 0 || global_watchlist.current_list >= global_watchlist.lists.length)
		return;
	global_watchlist.current_item = (global_watchlist.current_item + 1) % global_watchlist.lists[global_watchlist.current_list].length;
}

function selectWatchList(index)
{
	if(index < 0 || index >= global_watchlist.lists.length) {
		findTargetByName();
		document.getElementById("wl_ctl").style.display = 'none';
		document.getElementById("wl_sel").innerHTML = "None";
		global_watchlist.current_list = -1;
		global_watchlist.current_item = -1;
	}
	else {
		document.getElementById("wl_ctl").style.display = "inline";
		document.getElementById("wl_sel").innerHTML = global_watchlist.names[index];
		global_watchlist.current_list = index;
		global_watchlist.current_item = 0;
		findTargetByName(global_watchlist.lists[index][0]);
	}
	markTarget();
}


function tokenizeWL(text)
{
	const re=/(,|:|"[^"]*"|\s+|[^\s:,"]*)/;
	const ws=/^\s+$/;
	var items=text.split(re);
	return items.filter(x=>x.trim() != "" && x!=",");
}


function parseWatchList(text)
{
	var wl = {
		lists: [],
		names: [],
		current_list: -1,
		current_item: -1
	};
	var not_found = [];
	var index={};
	var items = tokenizeWL(text);
	var list_name = "default";
	for(var i=0;i<items.length;i++) {
		var item = items[i];
		item = item.replace(/"/g,'')
		if(i+1 < items.length && items[i+1] == ":") {
			list_name = item;
			i+=1;
			continue;
		}
		var nitem = item.toUpperCase();
		if(allstars_index_name.names.findIndex(x=>x==nitem) == -1) {
			not_found.push(item)
		}
		if(!(list_name in index)) {
			index[list_name] = wl.names.length;
			wl.names.push(list_name);
			wl.lists.push(new Array());
		}
		wl.lists[index[list_name]].push(item);
	}
	return [wl,not_found]
}

function loadWL()
{
	var wl_text = window.localStorage.getItem("watch_list");
	if(!wl_text)
		wl_text = "";
	var wl = parseWatchList(wl_text);
	global_watchlist = wl[0];
	document.getElementById("user_wl").value = wl_text;
}

function toggleEditWL()
{
	toggleUI('list_edit_toggle','wl_edit');
}

function saveWL()
{
	var text = document.getElementById("user_wl").value;
	var wl_all = parseWatchList(text);
	var wl = wl_all[0];
	var errors = wl_all[1];
	var emsg = document.getElementById("wl_errors");
	if(errors.length > 0) {
		var msg="Not Found:";
		for(var i=0;i<errors.length;i++) {
			if(i > 0)
				msg = msg + ", " + errors[i];
			else
				msg = msg + errors[i];
		}
		emsg.innerHTML = msg;
		return;
	}
	emsg.innerHTML = "";
	setWatchList(wl);
	window.localStorage.setItem("watch_list",text);
	toggleEditWL();
}

function discardWL()
{
	var wl_text = window.localStorage.getItem("watch_list");
	if(!wl_text)
		wl_text = "";
	document.getElementById("user_wl").value = wl_text;
	toggleEditWL();
}

function iOSOrientation()
{
	//Notification.requestPermission().then(response => {
	DeviceOrientationEvent.requestPermission().then(response => {
		if (response == 'granted') {
			document.getElementById("allow_orientation").style.display='none';
			setupiOSOrientationEvents();
		}
	})
	.catch(console.error)
}

function setupGyros()
{
	//if (typeof window.Notification.requestPermission === 'function') {
	if (typeof window.DeviceOrientationEvent.requestPermission === 'function') {
		document.getElementById("allow_orientation").style.display='inline';
	}
	else {
		setupOrientationEvents();
	}
}

function switchNightMode(is_night)
{
	global_style = is_night ? global_night_style : global_day_style;
}


function dsoMagUpdate(offset)
{
	global_dso_mag = global_dso_mag + offset;
	if(global_dso_mag < 3)
		global_dso_mag = 3;
	else if(global_dso_mag > 16)
		global_dso_mag = 16;
	document.getElementById('dso_level_val').innerHTML = '' + global_dso_mag;
}

function loadUserDSO()
{
    var storage = window.localStorage;
    var user_dso = storage.getItem('user_dso');
    document.getElementById("user_dso").value = user_dso;
    var dso = user_dso ? parseUserDSO(user_dso)[0] : [];
    resetUserDSOsAndMergeNewToAllStars(dso);
}




setupGyros();
// global drawing stuff
var canvas = document.getElementById('myCanvas');
canvas.width = document.body.clientWidth;
canvas.height = document.body.clientHeight;
var context = canvas.getContext('2d');
setTimeout(getLocation,500)
setTimeout(plotStars,1000)
loadUserDSO();
loadWL();
document.body.addEventListener('mousedown',selectionEvent);
document.body.addEventListener('touchstart',manualDown);
document.body.addEventListener('touchend',manualUp);
document.body.addEventListener('touchcancel',manualUp);
document.body.addEventListener('touchmove',manualMove);
dontPropMouseDown(["ui_but","incdec_but","config_div","comp_but"]);
global_expecting_select = selectTaret;

</script>


</body>
</html>
